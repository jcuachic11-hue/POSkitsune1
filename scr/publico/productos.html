<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti贸n de Productos</title>
  <!--  Favicon para evitar error en consola -->
  <link rel="icon" href="data:,">
</head>
<body>
  <h2>Gesti贸n de Productos</h2>
  <table id="productosTable" border="1">
    <thead>
      <tr>
        <th>ID</th><th>Nombre</th><th>Descripci贸n</th><th>Precio</th><th>Stock</th><th>Categor铆a</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Agregar/Editar Producto</h3>
  <form id="productoForm">
    <input type="hidden" id="id">
    <label>Nombre: <input type="text" id="nombre"></label><br>
    <label>Descripci贸n: <textarea id="descripcion"></textarea></label><br>
    <label>Precio: <input type="number" id="precio"></label><br>
    <label>Stock: <input type="number" id="stock"></label><br>
    <label>Categor铆a: <input type="text" id="categoria"></label><br>
    <button type="submit">Guardar</button>
  </form>

  <script>
    const API_URL = 'http://localhost:3000/productos';
    const token = localStorage.getItem('token');

    if (!token) {
      alert("No hay token de sesi贸n. Primero inicia sesi贸n.");
    }

    async function cargarProductos() {
      if (!token) return;
      try {
        const res = await fetch(API_URL, { headers: { Authorization: 'Bearer ' + token } });
        const data = await res.json();
        console.log("Productos recibidos:", data);
        const tbody = document.querySelector('#productosTable tbody');
        tbody.innerHTML = '';
        data.forEach(p => {
          tbody.innerHTML += `
            <tr>
              <td>${p.id}</td>
              <td>${p.nombre}</td>
              <td>${p.descripcion}</td>
              <td>${p.precio}</td>
              <td>${p.stock}</td>
              <td>${p.categoria}</td>
              <td>
                <button onclick="editarProducto(${p.id}, \`${p.nombre}\`, \`${p.descripcion}\`, ${p.precio}, ${p.stock}, \`${p.categoria}\`)">Editar</button>
                <button onclick="eliminarProducto(${p.id}, \`${p.nombre}\`)">Eliminar</button>
              </td>
            </tr>`;
        });
      } catch (err) {
        console.error("Error cargando productos:", err);
        alert("No se pudieron cargar los productos.");
      }
    }

    document.getElementById('productoForm').addEventListener('submit', async e => {
      e.preventDefault();
      if (!token) return alert("No hay token de sesi贸n. Primero inicia sesi贸n.");

      const id = document.getElementById('id').value;
      const nombre = document.getElementById('nombre').value;
      const descripcion = document.getElementById('descripcion').value;
      const precio = document.getElementById('precio').value;
      const stock = document.getElementById('stock').value;
      const categoria = document.getElementById('categoria').value;

      const method = id ? 'PUT' : 'POST';
      const url = id ? API_URL + '/' + id : API_URL;

      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ nombre, descripcion, precio, stock, categoria })
      });
      cargarProductos();
       document.getElementById('productoForm').reset();
  document.getElementById('id').value = '';


   
    });

    async function eliminarProducto(id, nombre) {
      if (!token) return alert("No hay token de sesi贸n. Primero inicia sesi贸n.");
      if (confirm("驴Seguro que quieres eliminar el producto '" + nombre + "' (ID " + id + ")?")) {
        await fetch(API_URL + '/' + id, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        cargarProductos();
      }
    }

    function editarProducto(id, nombre, descripcion, precio, stock, categoria) {
      document.getElementById('id').value = id;
      document.getElementById('nombre').value = nombre;
      document.getElementById('descripcion').value = descripcion;
      document.getElementById('precio').value = precio;
      document.getElementById('stock').value = stock;
      document.getElementById('categoria').value = categoria;
    }

    //  Recarga al volver con backspace
    window.addEventListener("pageshow", function() {
      cargarProductos();
    });

    // llamada inicial
    cargarProductos();
  </script>
</body>
</html>
